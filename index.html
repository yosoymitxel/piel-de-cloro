<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piel de Cloro: El Ciclo de la Paranoia</title>
    
    <!-- Librerías Externas (CDNs) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Configuración Tailwind (Mantenemos solo lo necesario para layout) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        chlorine: '#2d5a27',
                        'chlorine-light': '#a8d5a2',
                        alert: '#ff3333'
                    }
                }
            }
        }
    </script>

    <!-- Estilos -->
    <link rel="stylesheet" href="css/avatars.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="flex justify-center items-center min-h-screen">
    <!-- FX Layers -->
    <div class="crt-overlay fixed inset-0 w-full h-full pointer-events-none"></div>
    <div class="dirty-lens fixed inset-0 w-full h-full pointer-events-none"></div>
    <div class="scanline fixed w-full h-[100px] z-20 bg-gradient-to-t from-transparent via-chlorine/10 to-transparent opacity-10 animate-[scanline_10s_linear_infinite] pointer-events-none"></div>

    <!-- Game Container -->
    <div class="game-container w-[95%] max-w-[900px] h-[90vh] horror-panel flex relative z-10">
        
        <!-- SIDEBAR NAVIGATION -->
        <aside id="sidebar-left" class="w-20 horror-sidebar flex flex-col pt-5 hidden">
            <button id="nav-shelter" class="nav-btn group flex flex-col items-center gap-1 p-4 w-full">
                <i class="fa-solid fa-house text-2xl"></i>
                <span class="cfont-bold">REFUGIO</span>
            </button>
            <button id="nav-room" class="nav-btn group flex flex-col items-center gap-1 p-4 w-full">
                <i class="fa-solid fa-bell text-2xl"></i>
                <span class="font-bold">SALA</span>
            </button>
            <button id="nav-morgue" class="nav-btn group flex flex-col items-center gap-1 p-4 w-full">
                <i class="fa-solid fa-skull text-2xl"></i>
                <span class="font-bold">MORGUE</span>
            </button>
            <button id="nav-guard" class="nav-btn group flex flex-col items-center gap-1 p-4 w-full active">
                <i class="fa-solid fa-shield-halved text-2xl"></i>
                <span class="font-bold">PUESTO</span>
            </button>
            <div class="mt-auto pb-3 px-2">
                <button id="nav-morgue-stats" class="nav-btn group flex flex-col items-center gap-1 p-3 w-full" title="Estadísticas de partida (Morgue)">
                    <i class="fa-solid fa-chart-line text-2xl"></i>
                    <span class="font-bold text-[0.6rem]">ESTADÍSTICAS</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div class="flex-grow relative flex flex-col overflow-hidden horror-panel-inner m-1">
            
            <!-- SCREEN 1: START -->
            <section id="screen-start" class="h-full flex flex-col justify-center items-center gap-6 p-4 animate__animated animate__fadeIn">
                <h1 class="text-6xl font-bold text-chlorine text-glow glitch-effect" data-text="PIEL DE CLORO">PIEL DE CLORO</h1>
                <h2 class="text-xl tracking-[0.5em] opacity-80">PROTOCOLO DE SEGURIDAD</h2>
                <div class="italic text-center text-sm opacity-60 font-mono mt-4">
                    "Identifica a los infectados. Protege el refugio."
                </div>
                <button id="btn-start-game" class="horror-btn horror-btn-primary py-4 px-12 text-2xl mt-8">
                    INICIAR TURNO
                </button>
            </section>

            <!-- SCREEN 2: GAME (Guard Post) -->
            <section id="screen-game" class="h-full flex flex-col p-4 gap-4 animate__animated animate__fadeIn hidden">
                <header class="flex justify-between border-b border-chlorine pb-2 font-mono text-lg">
                    <div class="flex gap-6">
                        <span>PARANOIA: <span id="paranoia-level" class="text-chlorine-light font-bold">0%</span></span>
                        <span>ENERGÍA: <span id="scan-energy" class="text-cyan-400 text-glow">⚡⚡</span></span>
                    </div>
                    <div class="flex gap-6">
                        <span>CICLO: <span id="cycle-count">1</span></span>
                        <span>HORA: <span id="time-display">08:00</span></span>
                    </div>
                </header>

                <main class="flex-grow bg-[#020202] border border-[#1a3317] relative flex flex-col items-center justify-center overflow-hidden min-h-[200px] vhs-target">
                    <!-- Background Grid Effect -->
                    <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#2d5a27 1px, transparent 1px), linear-gradient(90deg, #2d5a27 1px, transparent 1px); background-size: 20px 20px;"></div>
                    
                    <div id="npc-display" class="flex justify-center items-center relative transition-all duration-150 z-10">
                        <!-- JS renders visuals here -->
                    </div>
                    <div id="inspection-feedback" class="mt-4 font-bold text-shadow h-5 hidden z-20"></div>
                </main>

                <section class="border-t border-chlorine pt-3 flex flex-col gap-3">
                    <div class="bg-black/80 p-3 border border-[#1a3317] min-h-[100px] shadow-inner">
                        <p id="npc-dialogue" class="mb-3 font-mono text-lg text-white">Esperando sujeto...</p>
                        <div id="dialogue-options" class="flex flex-wrap gap-2">
                            <!-- Buttons generated by JS -->
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-3">
                        <button id="tool-thermo" class="horror-btn horror-btn-tool">
                            <i class="fa-solid fa-temperature-half"></i> TERMÓMETRO
                        </button>
                        <button id="tool-flash" class="horror-btn horror-btn-tool">
                            <i class="fa-solid fa-lightbulb"></i> LINTERNA UV
                        </button>
                        <button id="tool-pulse" class="horror-btn horror-btn-tool">
                            <i class="fa-solid fa-heart-pulse"></i> PULSO
                        </button>
                        <button id="tool-pupils" class="horror-btn horror-btn-tool">
                            <i class="fa-solid fa-eye"></i> PUPILAS
                        </button>
                    </div>

                    <div class="flex gap-3 mt-1">
                        <button id="btn-admit" class="horror-btn horror-btn-primary flex-grow p-4 text-xl">
                            <i class="fa-solid fa-check mr-2"></i> ADMITIR
                        </button>
                        <button id="btn-ignore" class="horror-btn horror-btn-warning flex-grow p-4 text-xl">
                            <i class="fa-solid fa-eye-slash mr-2"></i> IGNORAR
                        </button>
                    </div>
                </section>
            </section>

            <!-- SCREEN 3: SHELTER GRID -->
            <section id="screen-shelter" class="h-full flex flex-col p-4 gap-4 animate__animated animate__fadeIn hidden">
                <header class="flex justify-between items-center border-b border-chlorine pb-2">
                    <h2 class="text-2xl text-glow">HABITANTES DEL REFUGIO</h2>
                    <span class="font-mono text-xl">OCUPACIÓN: <span id="shelter-count">0/10</span></span>
                </header>
                <div id="dayafter-panel" class="horror-panel p-3 bg-[#080808] border-chlorine-dim">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-vial text-chlorine-light"></i>
                            <span class="font-mono text-sm">Tests disponibles: <span id="dayafter-tests-left">0</span></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-users text-chlorine-light"></i>
                            <span class="font-mono text-sm">Grupo de testeo: <span id="dayafter-group-limit">0</span></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-shield-heart text-chlorine-light"></i>
                            <span class="font-mono text-sm">Validados: <span id="dayafter-validated-count">0</span></span>
                        </div>
                    </div>
                <div id="dayafter-list" class="grid grid-cols-[repeat(auto-fill,minmax(220px,1fr))] gap-3 mt-3"></div>
                </div>
                <div id="shelter-grid" class="grid grid-cols-[repeat(auto-fill,minmax(120px,1fr))] gap-4 overflow-y-auto p-2 custom-scroll">
                    <!-- Cards items -->
                </div>
                <div class="flex justify-center mt-4">
                    <button id="btn-finalize-day-no-purge" class="horror-btn horror-btn-primary p-4 min-w-[220px] hidden">
                        <i class="fa-solid fa-check mr-2"></i> FINALIZAR EL DÍA SIN PURGAR
                    </button>
                </div>
            </section>
            
            <!-- SCREEN: SECURITY ROOM -->
            <section id="screen-room" class="h-full flex flex-col p-4 gap-4 animate__animated animate__fadeIn hidden">
                <header class="flex justify-between items-center border-b border-chlorine pb-2">
                    <h2 class="text-2xl text-glow">SALA DE VIGILANCIA</h2>
                    <span class="font-mono text-xl">Puntos: <span id="security-count">0</span></span>
                </header>
                <div class="italic text-sm text-gray-400">Verifica los elementos para reducir intrusiones nocturnas.</div>
                <div id="security-grid" class="grid grid-cols-[repeat(auto-fill,minmax(160px,1fr))] gap-4 overflow-y-auto p-2 custom-scroll">
                    <!-- Items -->
                </div>
            </section>

            <!-- SCREEN 4: MORGUE GRID -->
            <section id="screen-morgue" class="h-full flex flex-col p-4 gap-4 animate__animated animate__fadeIn hidden">
                <header class="border-b border-chlorine pb-2">
                    <h2 class="text-2xl text-alert-glow text-alert">REGISTRO DE PURGAS</h2>
                </header>
                <div id="morgue-grid" class="grid grid-cols-[repeat(auto-fill,minmax(120px,1fr))] gap-4 overflow-y-auto p-2 custom-scroll">
                    <!-- Cards items -->
                </div>
            </section>

            <!-- SCREEN 5: SETTINGS -->
            <section id="screen-settings" class="h-full flex flex-col p-4 gap-4 animate__animated animate__fadeIn hidden">
                <header class="border-b border-chlorine pb-2"><h2 class="text-2xl">CONFIGURACIÓN DEL SISTEMA</h2></header>
                <div class="flex flex-col gap-8 max-w-md mx-auto w-full mt-10">
                    <label class="flex flex-col gap-3 text-center font-mono text-xl">
                        CAPACIDAD DEL REFUGIO:
                        <input type="number" id="config-max-shelter" value="10" min="1" max="50" class="horror-input p-3 text-2xl">
                    </label>
                    <label class="flex flex-col gap-3 text-center font-mono text-xl">
                        DURACIÓN DEL DÍA (Sujetos):
                        <input type="number" id="config-day-length" value="5" min="1" max="20" class="horror-input p-3 text-2xl">
                    </label>
                    <label class="flex flex-col gap-3 text-center font-mono text-xl">
                        TESTS DISPONIBLES (Día después):
                        <input type="number" id="config-dayafter-tests" value="5" min="0" max="20" class="horror-input p-3 text-2xl">
                    </label>
                    <button id="btn-close-settings" class="horror-btn horror-btn-primary mt-8 p-4 text-xl">
                        GUARDAR Y SALIR
                    </button>
                </div>
            </section>

            <!-- SCREEN LORE: DEDICADA -->
            <section id="screen-lore" class="h-full flex flex-col animate__animated animate__fadeIn hidden">
                <div class="flex-grow relative bg-gradient-to-b from-[#000000] to-[#0b0f0b] overflow-hidden flex items-center justify-center">
                    <div class="horror-panel lore-panel w-[90%] max-w-[600px] p-8 text-center">
                        <h3 id="lore-screen-title" class="text-3xl mb-4 text-glow"></h3>
                        <div id="lore-screen-content" class="font-mono text-sm text-gray-300 leading-relaxed"></div>
                        <div class="flex justify-center mt-6">
                            <button id="btn-lore-continue-screen" class="horror-btn horror-btn-primary px-10 py-3">CONTINUAR</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SCREEN 6: NIGHT PHASE -->
            <section id="screen-night" class="h-full flex flex-col animate__animated animate__fadeIn hidden">
                <div class="flex-grow relative bg-gradient-to-b from-[#020502] to-[#0a1a0a] overflow-hidden flex items-center justify-center">
                    <div class="text-center opacity-50">
                        <i class="fa-solid fa-moon text-6xl text-chlorine-light mb-4 animate-pulse"></i>
                    </div>
                    <div class="absolute bottom-0 w-full h-[100px] bg-[linear-gradient(to_top,#000,transparent)]"></div>
                </div>
                <div class="p-6 bg-[#050505] border-t border-chlorine text-center">
                    <h3 class="text-3xl mb-2 text-glow">FIN DEL TURNO</h3>
                    <p class="mb-6 font-mono text-lg text-gray-400">La noche ha caído. El refugio está en silencio...</p>
                    <div class="flex justify-center gap-6">
                        <button id="btn-sleep" class="horror-btn horror-btn-primary p-4 min-w-[150px]">
                            <i class="fa-solid fa-bed mr-2"></i> DORMIR
                        </button>
                        <button id="btn-night-escape" class="horror-btn horror-btn-alert p-4 min-w-[150px]">
                            <i class="fa-solid fa-person-running mr-2"></i> ESCAPAR
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- SETTINGS BUTTON (Bottom Right) -->
        <button id="btn-settings-toggle" class="absolute bottom-5 right-5 w-12 h-12 rounded-full bg-black border border-chlorine text-chlorine flex justify-center items-center z-20 hover:rotate-90 transition-transform duration-300 hover:shadow-[0_0_15px_#2d5a27]" title="Configuración">
            <i class="fa-solid fa-gear text-xl"></i>
        </button>

        <div id="stats-panel" class="absolute top-0 right-0 h-full w-[260px] bg-[#060606] border-l border-chlorine-dim p-3 flex flex-col gap-3 hidden z-20">
            <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-sm tracking-wide">ESTADÍSTICAS DE PARTIDA</span>
                <button id="btn-stats-refresh" class="px-2 py-1 border border-chlorine-light text-chlorine-light text-xs">Actualizar</button>
            </div>
            <div class="space-y-2">
                <div class="stat-item">
                    <span class="label">Diálogos realizados</span>
                    <span id="stat-run-dialogues" class="value">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Verificaciones realizadas</span>
                    <span id="stat-run-verifications" class="value">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Admitidos</span>
                    <span id="stat-run-admitted" class="value">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Ignorados</span>
                    <span id="stat-run-ignored" class="value">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Cloros vistos</span>
                    <span id="stat-run-cloros-vistos" class="value">—</span>
                </div>
                <div class="stat-item">
                    <span class="label">Cloros fuera del refugio</span>
                    <span id="stat-run-cloros-fuera" class="value">—</span>
                </div>
                <div class="stat-item">
                    <span class="label">Cloros purgados</span>
                    <span id="stat-run-cloros-purgados" class="value">—</span>
                </div>
                <div class="stat-item">
                    <span class="label">Civiles muertos</span>
                    <span id="stat-run-civiles-muertos" class="value">0</span>
                </div>
                <div class="stat-item">
                    <span class="label">Civiles purgados</span>
                    <span id="stat-run-civiles-purgados" class="value">—</span>
                </div>
                <div class="stat-item">
                    <span class="label">Última noche</span>
                    <span id="stat-run-last-night" class="value">—</span>
                </div>
            </div>
            <div class="mt-3">
                <div class="stat-item badge-rt">
                    <span class="label">Usuarios activos</span>
                    <span id="stat-rt-users" class="value">0</span>
                </div>
                <div class="stat-item badge-rt">
                    <span class="label">Transacciones</span>
                    <span id="stat-rt-transactions" class="value">0</span>
                </div>
                <div class="stat-item badge-rt">
                    <span class="label">Eventos</span>
                    <span id="stat-rt-events" class="value">0</span>
                </div>
                <div class="stat-item badge-rt">
                    <span class="label">Alertas</span>
                    <span id="stat-rt-alerts" class="value">0</span>
                </div>
            </div>
            <div class="mt-3 space-y-2">
                <div class="stat-item badge-night">
                    <span class="label">Consolidado nocturno</span>
                    <span id="stat-night-consolidated" class="value">0</span>
                </div>
                <div class="stat-item badge-night">
                    <span class="label">Promedio</span>
                    <span id="stat-night-average" class="value">0</span>
                </div>
                <div class="stat-item badge-night">
                    <span class="label">Tendencia</span>
                    <span id="stat-night-trend" class="value trend">0%</span>
                </div>
                <div class="stat-item badge-night">
                    <span class="label">Próxima actualización</span>
                    <span id="stat-night-next-refresh" class="value">--:--</span>
                </div>
            </div>
        </div>

    </div>

    <!-- NPC DETAIL MODAL -->
    <div id="modal-npc" class="fixed inset-0 bg-black/90 flex justify-center items-center z-50 hidden backdrop-blur-sm">
        <div class="horror-panel w-[90%] max-w-[500px] p-6 flex flex-col gap-4 animate__animated animate__zoomIn">
            <span class="close-modal self-end text-3xl cursor-pointer hover:text-alert leading-none">&times;</span>
            <h2 id="modal-npc-name" class="text-2xl border-b border-chlorine pb-2 glitch-effect" data-text="SUJETO X">SUJETO X</h2>
            
            <div class="flex gap-6 items-center border-b border-chlorine-dim pb-4">
                <div id="modal-npc-visual" class="w-[80px] h-[80px] flex-shrink-0 scale-125 origin-center"></div>
                <div class="flex-grow font-mono">
                    <p class="text-sm text-gray-400">ESTADO: <span id="modal-npc-status" class="font-bold">ADMITIDO</span></p>
                    <div id="modal-npc-stats-content" class="mt-3 text-sm space-y-1">
                         <!-- Stats injected here -->
                    </div>
                </div>
            </div>
            
            <div id="modal-npc-log" class="max-h-[200px] overflow-y-auto bg-black p-4 border border-chlorine-dim text-xs font-mono text-chlorine-light custom-scroll">
                <!-- History -->
            </div>
            
            <div class="flex justify-center mt-4">
                <button id="btn-modal-purge" class="horror-btn horror-btn-alert p-3 w-full hidden">
                    <i class="fa-solid fa-biohazard mr-2"></i> PURGAR DEL REFUGIO
                </button>
            </div>
            <div id="modal-error" class="mt-2 text-alert text-center text-sm hidden"></div>
        </div>
    </div>

    <!-- MESSAGE MODAL (Generic) -->
    <div id="modal-message" class="fixed inset-0 bg-black/90 flex justify-center items-center z-50 hidden backdrop-blur-sm">
        <div class="horror-panel w-[90%] max-w-[400px] p-8 flex flex-col gap-6 text-center animate__animated animate__fadeInUp">
            <div id="modal-message-content" class="text-xl font-head tracking-wider">
                MENSAJE DEL SISTEMA
            </div>
            <div class="flex justify-center">
                <button id="btn-message-ok" class="horror-btn horror-btn-primary px-10 py-3">
                    ENTENDIDO
                </button>
            </div>
        </div>
    </div>

    <div id="validation-overlay" class="fixed inset-0 bg-black/85 flex justify-center items-center z-50 hidden">
        <div class="horror-panel w-[90%] max-w-[420px] p-6 flex flex-col gap-5 text-center">
            <h3 class="text-2xl font-bold">Validación requerida</h3>
            <p class="font-mono text-sm text-gray-300">Debes realizar un test o participar en un diálogo para omitirlo antes de continuar.</p>
            <div class="flex gap-4 justify-center">
                <button id="btn-do-test" class="horror-btn horror-btn-primary px-6 py-3">REALIZAR TEST</button>
                <button id="btn-omit-test" class="horror-btn horror-btn-warning px-6 py-3">OMITIR TEST</button>
            </div>
        </div>
    </div>

    <div id="lore-overlay" class="fixed inset-0 bg-black/85 flex justify-center items-center z-50 hidden">
        <div class="horror-panel w-[90%] max-w-[520px] p-8 flex flex-col gap-6 text-center">
            <h3 id="lore-title" class="text-2xl font-bold"></h3>
            <div id="lore-content" class="font-mono text-sm text-gray-300"></div>
            <div class="flex justify-center">
                <button id="btn-lore-continue" class="horror-btn horror-btn-primary px-10 py-3">CONTINUAR</button>
            </div>
        </div>
    </div>

    <div id="preclose-overlay" class="fixed inset-0 bg-black/85 flex justify-center items-center z-50 hidden">
        <div class="horror-panel w-[90%] max-w-[520px] p-8 flex flex-col gap-6 text-center">
            <div id="preclose-step1" class="flex flex-col gap-4">
                <h3 class="text-2xl font-bold">Antes de cerrar el día</h3>
                <p class="font-mono text-sm text-gray-300">Primero puedes purgar desde el Refugio.</p>
                <div class="flex gap-4 justify-center">
                    <button id="btn-preclose-open-shelter" class="horror-btn horror-btn-alert px-6 py-3">ABRIR REFUGIO</button>
                    <button id="btn-preclose-continue" class="horror-btn horror-btn-primary px-6 py-3">CONTINUAR</button>
                </div>
            </div>
            <div id="preclose-step2" class="flex flex-col gap-4 hidden">
                <h3 class="text-2xl font-bold">¿Finalizar sesión o permanecer?</h3>
                <p class="font-mono text-sm text-gray-300">Puedes finalizar la sesión o permanecer para la noche.</p>
                <div class="flex gap-4 justify-center">
                    <button id="btn-preclose-finish" class="horror-btn horror-btn-primary px-6 py-3">FINALIZAR SESIÓN</button>
                    <button id="btn-preclose-stay" class="horror-btn horror-btn-warning px-6 py-3">PERMANECER</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>
